# HiPart is a software toolkit to analyse molecular densities with the hirshfeld partitioning scheme.
# Copyright (C) 2007 - 2010 Toon Verstraelen <Toon.Verstraelen@UGent.be>
#
# This file is part of HiPart.
#
# HiPart is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# HiPart is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
#
# --


from hipart.cache import HirshfeldCache
from hipart.context import Context
from hipart.tools import load_charges, load_dipoles, dump_charges

from molmod import angstrom
import tempfile, shutil, os


class FakeOptions(object):
    def __init__(self, lebedev, mol_lebedev, clean, threshold, max_iter, fix_total_charge):
        self.lebedev = lebedev
        self.mol_lebedev = mol_lebedev
        self.clean = clean
        self.threshold = threshold
        self.max_iter = max_iter
        self.fix_total_charge = fix_total_charge


hf_fchk="""\
blablabla
SP        RHF                                                         STO-3G
Number of atoms                            I                2
Charge                                     I                0
Multiplicity                               I                1
Number of electrons                        I               10
Number of alpha electrons                  I                5
Number of beta electrons                   I                5
Number of basis functions                  I                6
Number of independant functions            I                6
Number of contracted shells                I                3
Highest angular momentum                   I                1
Largest degree of contraction              I                3
Number of primitive shells                 I                9
SCF Energy                                 R     -9.856961609951867E+01
Total Energy                               R     -9.856961609951867E+01
Atomic numbers                             I   N=           2
           9           1
Nuclear charges                            R   N=           2
  9.00000000E+00  1.00000000E+00
Current cartesian coordinates              R   N=           6
  0.00000000E+00  0.00000000E+00  1.90484394E-01  0.00000000E+00  0.00000000E+00
 -1.71435955E+00
Shell types                                I   N=           3
           0          -1           0
Number of primitives per shell             I   N=           3
           3           3           3
Shell to atom map                          I   N=           3
           1           1           2
Primitive exponents                        R   N=           9
  1.66679134E+02  3.03608123E+01  8.21682067E+00  6.46480325E+00  1.50228124E+00
  4.88588486E-01  3.42525091E+00  6.23913730E-01  1.68855404E-01
Contraction coefficients                   R   N=           9
  1.54328967E-01  5.35328142E-01  4.44634542E-01 -9.99672292E-02  3.99512826E-01
  7.00115469E-01  1.54328967E-01  5.35328142E-01  4.44634542E-01
P(S=P) Contraction coefficients            R   N=           9
  0.00000000E+00  0.00000000E+00  0.00000000E+00  1.55916275E-01  6.07683719E-01
  3.91957393E-01  0.00000000E+00  0.00000000E+00  0.00000000E+00
Alpha Orbital Energies                     R   N=           6
 -2.59083334E+01 -1.44689996E+00 -5.57467136E-01 -4.62288194E-01 -4.62288194E-01
  5.39578910E-01
Alpha MO coefficients                      R   N=          36
  9.94803448E-01  2.18171240E-02  0.00000000E+00  0.00000000E+00 -2.32641328E-03
 -4.79956235E-03 -2.52541943E-01  9.59473606E-01  0.00000000E+00  0.00000000E+00
 -6.43303484E-02  1.39537839E-01 -7.25975847E-02  3.79097630E-01  0.00000000E+00
  0.00000000E+00  6.93582825E-01 -5.48754967E-01  0.00000000E+00  0.00000000E+00
  1.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  7.48777677E-02 -4.62627490E-01  0.00000000E+00  0.00000000E+00  8.05942415E-01
  1.01124712E+00
Total SCF Density                          R   N=          21
  2.11736348E+00 -4.96250301E-01  2.12956120E+00  0.00000000E+00  0.00000000E+00
  2.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  2.00000000E+00
 -7.28413014E-02  4.02323157E-01  0.00000000E+00  0.00000000E+00  9.70401883E-01
 -3.50985618E-04 -1.48507094E-01  0.00000000E+00  0.00000000E+00 -7.79144745E-01
  6.41251717E-01
Dipole Moment                              R   N=           3
  0.00000000E+00  0.00000000E+00 -4.73896291E-01
"""

densities_txt="""\
Radii [bohr]               3.7794523e-05 4.3454517e-05 4.9962135e-05 5.7444314e-05 6.6047002e-05 7.5938002e-05 8.7310249e-05 1.0038557e-04 1.1541901e-04 1.3270382e-04 1.5257714e-04 1.7542663e-04 2.0169800e-04 2.3190369e-04 2.6663289e-04 3.0656303e-04 3.5247298e-04 4.0525828e-04 4.6594854e-04 5.3572759e-04 6.1595655e-04 7.0820035e-04 8.1425831e-04 9.3619919e-04 1.0764016e-03 1.2376002e-03 1.4229395e-03 1.6360347e-03 1.8810423e-03 2.1627415e-03 2.4866272e-03 2.8590170e-03 3.2871748e-03 3.7794523e-03 4.3454517e-03 4.9962135e-03 5.7444314e-03 6.6047002e-03 7.5938002e-03 8.7310249e-03 1.0038557e-02 1.1541901e-02 1.3270382e-02 1.5257714e-02 1.7542663e-02 2.0169800e-02 2.3190369e-02 2.6663289e-02 3.0656303e-02 3.5247298e-02 4.0525828e-02 4.6594854e-02 5.3572759e-02 6.1595655e-02 7.0820035e-02 8.1425831e-02 9.3619919e-02 1.0764016e-01 1.2376002e-01 1.4229395e-01 1.6360347e-01 1.8810423e-01 2.1627415e-01 2.4866272e-01 2.8590170e-01 3.2871748e-01 3.7794523e-01 4.3454517e-01 4.9962135e-01 5.7444314e-01 6.6047002e-01 7.5938002e-01 8.7310249e-01 1.0038557e+00 1.1541901e+00 1.3270382e+00 1.5257714e+00 1.7542663e+00 2.0169800e+00 2.3190369e+00 2.6663289e+00 3.0656303e+00 3.5247298e+00 4.0525828e+00 4.6594854e+00 5.3572759e+00 6.1595655e+00 7.0820035e+00 8.1425831e+00 9.3619919e+00 1.0764016e+01 1.2376002e+01 1.4229395e+01 1.6360347e+01 1.8810423e+01 2.1627415e+01 2.4866272e+01 2.8590170e+01 3.2871748e+01 3.7794523e+01
Densities   1  H -1 [a.u.] 9.9197456e+00 9.9197456e+00 9.9197456e+00 9.9197455e+00 9.9197455e+00 9.9197454e+00 9.9197454e+00 9.9197453e+00 9.9197452e+00 9.9197450e+00 9.9197448e+00 9.9197445e+00 9.9197442e+00 9.9197437e+00 9.9197431e+00 9.9197423e+00 9.9197412e+00 9.9197398e+00 9.9197379e+00 9.9197354e+00 9.9197321e+00 9.9197278e+00 9.9197220e+00 9.9197144e+00 9.9197043e+00 9.9196910e+00 9.9196734e+00 9.9196502e+00 9.9196194e+00 9.9195788e+00 9.9195250e+00 9.9194540e+00 9.9193601e+00 9.9192360e+00 9.9190720e+00 9.9188551e+00 9.9185684e+00 9.9181895e+00 9.9176886e+00 9.9170264e+00 9.9161512e+00 9.9149944e+00 9.9134654e+00 9.9114447e+00 9.9087742e+00 9.9052455e+00 9.9005832e+00 9.8944245e+00 9.8862909e+00 9.8755522e+00 9.8613801e+00 9.8426869e+00 9.8180475e+00 9.7856014e+00 9.7429277e+00 9.6868944e+00 9.6134778e+00 9.5175583e+00 9.3927075e+00 9.2309987e+00 9.0229031e+00 8.7573784e+00 8.4223145e+00 8.0055632e+00 7.4968146e+00 6.8905121e+00 6.1897080e+00 5.4101236e+00 4.5827077e+00 3.7521597e+00 2.9692830e+00 2.2778694e+00 1.7015404e+00 1.2388470e+00 8.7140484e-01 5.8017946e-01 3.5656383e-01 1.9870236e-01 1.0025380e-01 4.6494187e-02 2.0134178e-02 7.9952053e-03 2.6972217e-03 6.8574510e-04 1.1461622e-04 1.0813664e-05 4.7730846e-07 7.7157516e-09 3.7699112e-11 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
Densities   1  H +0 [a.u.] 4.9598728e+00 4.9598728e+00 4.9598728e+00 4.9598728e+00 4.9598727e+00 4.9598727e+00 4.9598727e+00 4.9598726e+00 4.9598726e+00 4.9598725e+00 4.9598724e+00 4.9598723e+00 4.9598721e+00 4.9598719e+00 4.9598716e+00 4.9598711e+00 4.9598706e+00 4.9598699e+00 4.9598689e+00 4.9598677e+00 4.9598661e+00 4.9598639e+00 4.9598610e+00 4.9598572e+00 4.9598522e+00 4.9598455e+00 4.9598367e+00 4.9598251e+00 4.9598097e+00 4.9597894e+00 4.9597625e+00 4.9597270e+00 4.9596801e+00 4.9596180e+00 4.9595360e+00 4.9594276e+00 4.9592842e+00 4.9590947e+00 4.9588443e+00 4.9585132e+00 4.9580756e+00 4.9574972e+00 4.9567327e+00 4.9557223e+00 4.9543871e+00 4.9526227e+00 4.9502916e+00 4.9472123e+00 4.9431454e+00 4.9377761e+00 4.9306901e+00 4.9213434e+00 4.9090238e+00 4.8928007e+00 4.8714638e+00 4.8434472e+00 4.8067389e+00 4.7587792e+00 4.6963538e+00 4.6154994e+00 4.5114515e+00 4.3786892e+00 4.2111573e+00 4.0027816e+00 3.7484073e+00 3.4452560e+00 3.0948540e+00 2.7050618e+00 2.2913538e+00 1.8760799e+00 1.4846415e+00 1.1389347e+00 8.5077019e-01 6.1942350e-01 4.3570242e-01 2.9008973e-01 1.7828191e-01 9.9351178e-02 5.0126899e-02 2.3247093e-02 1.0067089e-02 3.9976027e-03 1.3486109e-03 3.4287254e-04 5.7308104e-05 5.4068318e-06 2.3864794e-07 3.8578758e-09 1.2566371e-11 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
Densities   9  F -1 [a.u.] 3.5164066e+03 3.5164063e+03 3.5164059e+03 3.5164054e+03 3.5164048e+03 3.5164039e+03 3.5164027e+03 3.5164012e+03 3.5163992e+03 3.5163965e+03 3.5163930e+03 3.5163884e+03 3.5163823e+03 3.5163741e+03 3.5163634e+03 3.5163492e+03 3.5163305e+03 3.5163057e+03 3.5162730e+03 3.5162297e+03 3.5161724e+03 3.5160968e+03 3.5159968e+03 3.5158646e+03 3.5156898e+03 3.5154588e+03 3.5151535e+03 3.5147499e+03 3.5142165e+03 3.5135115e+03 3.5125798e+03 3.5113487e+03 3.5097221e+03 3.5075734e+03 3.5047357e+03 3.5009889e+03 3.4960441e+03 3.4895215e+03 3.4809237e+03 3.4696009e+03 3.4547076e+03 3.4351493e+03 3.4095191e+03 3.3760257e+03 3.3324176e+03 3.2759144e+03 3.2031672e+03 3.1102841e+03 2.9929778e+03 2.8469156e+03 2.6683645e+03 2.4552049e+03 2.2082873e+03 1.9328919e+03 1.6397080e+03 1.3444393e+03 1.0652386e+03 8.1811905e+02 6.1216242e+02 4.4747977e+02 3.1779342e+02 2.1614680e+02 1.3908929e+02 8.5673634e+01 5.3440881e+01 3.6816014e+01 2.9165312e+01 2.5390834e+01 2.2720437e+01 2.0035900e+01 1.7029590e+01 1.3755729e+01 1.0403760e+01 7.1956453e+00 4.4163330e+00 2.3546480e+00 1.0930394e+00 4.5113331e-01 1.6580846e-01 5.0729091e-02 1.1214114e-02 1.4974856e-03 9.8957643e-05 2.5474798e-06 1.8761591e-08 2.5132741e-11 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
Densities   9  F +0 [a.u.] 3.5164066e+03 3.5164063e+03 3.5164059e+03 3.5164054e+03 3.5164048e+03 3.5164039e+03 3.5164027e+03 3.5164012e+03 3.5163992e+03 3.5163965e+03 3.5163930e+03 3.5163884e+03 3.5163823e+03 3.5163741e+03 3.5163634e+03 3.5163492e+03 3.5163305e+03 3.5163057e+03 3.5162730e+03 3.5162297e+03 3.5161724e+03 3.5160967e+03 3.5159967e+03 3.5158645e+03 3.5156897e+03 3.5154587e+03 3.5151533e+03 3.5147497e+03 3.5142162e+03 3.5135112e+03 3.5125794e+03 3.5113482e+03 3.5097214e+03 3.5075725e+03 3.5047344e+03 3.5009873e+03 3.4960419e+03 3.4895187e+03 3.4809199e+03 3.4695959e+03 3.4547010e+03 3.4351406e+03 3.4095076e+03 3.3760105e+03 3.3323974e+03 3.2758877e+03 3.2031320e+03 3.1102377e+03 2.9929166e+03 2.8468348e+03 2.6682582e+03 2.4550649e+03 2.2081034e+03 1.9326507e+03 1.6393925e+03 1.3440279e+03 1.0647046e+03 8.1742984e+02 6.1127962e+02 4.4636012e+02 3.1639150e+02 2.1442039e+02 1.3700817e+02 8.3231914e+01 5.0671375e+01 3.3801816e+01 2.6040934e+01 2.2324911e+01 1.9879334e+01 1.7542321e+01 1.4941306e+01 1.2079399e+01 9.1275486e+00 6.3028510e+00 3.8655346e+00 2.0631250e+00 9.6000586e-01 3.9685554e-01 1.4556865e-01 4.4267702e-02 9.7088183e-03 1.2866915e-03 8.4481109e-05 2.1633769e-06 1.5864967e-08 2.2149592e-11 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
Densities   9  F +1 [a.u.] 3.5164066e+03 3.5164063e+03 3.5164059e+03 3.5164054e+03 3.5164048e+03 3.5164039e+03 3.5164027e+03 3.5164012e+03 3.5163992e+03 3.5163965e+03 3.5163930e+03 3.5163884e+03 3.5163822e+03 3.5163741e+03 3.5163634e+03 3.5163492e+03 3.5163305e+03 3.5163057e+03 3.5162729e+03 3.5162296e+03 3.5161724e+03 3.5160967e+03 3.5159967e+03 3.5158644e+03 3.5156897e+03 3.5154586e+03 3.5151532e+03 3.5147495e+03 3.5142160e+03 3.5135109e+03 3.5125790e+03 3.5113476e+03 3.5097207e+03 3.5075716e+03 3.5047332e+03 3.5009857e+03 3.4960398e+03 3.4895158e+03 3.4809162e+03 3.4695909e+03 3.4546944e+03 3.4351318e+03 3.4094960e+03 3.3759952e+03 3.3323773e+03 3.2758611e+03 3.2030969e+03 3.1101913e+03 2.9928554e+03 2.8467541e+03 2.6681518e+03 2.4549250e+03 2.2079195e+03 1.9324095e+03 1.6390770e+03 1.3436165e+03 1.0641706e+03 8.1674064e+02 6.1039683e+02 4.4524047e+02 3.1498959e+02 2.1269399e+02 1.3492704e+02 8.0790195e+01 4.7901869e+01 3.0787617e+01 2.2916555e+01 1.9258987e+01 1.7038232e+01 1.5048743e+01 1.2853022e+01 1.0403069e+01 7.8513373e+00 5.4100568e+00 3.3147362e+00 1.7716020e+00 8.2697237e-01 3.4257777e-01 1.2532884e-01 3.7806313e-02 8.2035227e-03 1.0758973e-03 7.0004579e-05 1.7792688e-06 1.2969113e-08 1.7187115e-11 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
Densities   9  F +2 [a.u.] 3.5164066e+03 3.5164063e+03 3.5164059e+03 3.5164054e+03 3.5164048e+03 3.5164039e+03 3.5164027e+03 3.5164012e+03 3.5163992e+03 3.5163965e+03 3.5163930e+03 3.5163884e+03 3.5163822e+03 3.5163741e+03 3.5163634e+03 3.5163492e+03 3.5163305e+03 3.5163057e+03 3.5162729e+03 3.5162296e+03 3.5161724e+03 3.5160967e+03 3.5159966e+03 3.5158644e+03 3.5156896e+03 3.5154585e+03 3.5151531e+03 3.5147494e+03 3.5142158e+03 3.5135106e+03 3.5125786e+03 3.5113471e+03 3.5097200e+03 3.5075706e+03 3.5047319e+03 3.5009840e+03 3.4960376e+03 3.4895129e+03 3.4809124e+03 3.4695859e+03 3.4546878e+03 3.4351231e+03 3.4094845e+03 3.3759800e+03 3.3323571e+03 3.2758345e+03 3.2030617e+03 3.1101449e+03 2.9927941e+03 2.8466734e+03 2.6680455e+03 2.4547850e+03 2.2077356e+03 1.9321684e+03 1.6387614e+03 1.3432051e+03 1.0636366e+03 8.1605143e+02 6.0951403e+02 4.4412082e+02 3.1358767e+02 2.1096758e+02 1.3284591e+02 7.8348475e+01 4.5132363e+01 2.7773419e+01 1.9792177e+01 1.6193064e+01 1.4197129e+01 1.2555164e+01 1.0764738e+01 8.7267387e+00 6.5751261e+00 4.5172625e+00 2.7639378e+00 1.4800790e+00 6.9393888e-01 2.8830000e-01 1.0508903e-01 3.1344923e-02 6.6982271e-03 8.6510318e-04 5.5528052e-05 1.3951562e-06 1.0078229e-08 1.2566371e-11 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00"""

def test_compute_stockholder_weights():
    tmpdir = tempfile.mkdtemp("hipart-compute-stockholder-weights")
    fn_fchk = os.path.join(tmpdir, "hf.fchk")
    f = open(fn_fchk, "w")
    f.write(hf_fchk)
    f.close()
    fn_densities = os.path.join(tmpdir, "densities.txt")
    f = open(fn_densities, "w")
    f.write(densities_txt)
    f.close()
    options = FakeOptions(110, 50, 1, 1e-4, 500, True)
    context = Context(fn_fchk, options)
    cache = HirshfeldCache.new_from_args(context, [fn_densities])
    cache.do_atgrids()
    cache.do_proatomfns()
    h0 = cache._compute_atweights(cache.atgrids[0], 0)
    #print h0[:50]
    #print h0[4000:4050]
    #print h0[-50:]
    #print h0.shape
    h1 = cache._compute_atweights(cache.atgrids[0], 1)
    #print h1[:50]
    #print h1[4000:4050]
    #print h1[-50:]
    #print h1.shape
    #print h1+h0
    #print cache.get_rs(0,0)[-1]/angstrom
    assert(abs(h1+h0-1).max() < 1e-10)
    cache.do_charges()
    cache.do_dipoles()
    shutil.rmtree(tmpdir)


hirshi_charges_txt="""\
number of atoms: 2
  i        Z      Charge
-----------------------------
  1   F    9     -0.19457
  2   H    1      0.19457
-----------------------------
   Q SUM          0.00000
   Q RMS          0.19457
 ESP RMS          7.88796e-03
ESP RMSD          1.75095e-03"""

def test_load_charges():
    tmpdir = tempfile.mkdtemp("hipart-load-charges")
    fn_txt = os.path.join(tmpdir, "hirshi_charges.txt")
    f = open(fn_txt, "w")
    f.write(hirshi_charges_txt)
    f.close()
    charges = load_charges(fn_txt)
    assert(abs(charges[0] - (-0.19438)) < 1e-3)
    assert(abs(charges[1] - 0.19438) < 1e-3)
    shutil.rmtree(tmpdir)


def test_dump_charges():
    tmpdir = tempfile.mkdtemp("hipart-dump-charges")
    fn_txt = os.path.join(tmpdir, "foo_charges.txt")
    charges = [-0.3, 0.5]
    numbers = [2, 3]
    dump_charges(fn_txt, charges, numbers)
    check = load_charges(fn_txt)
    assert(len(charges)==len(check))
    assert(abs(charges-check).max() < 1e-5)
    dump_charges(fn_txt, charges)
    check = load_charges(fn_txt)
    assert(len(charges)==len(check))
    assert(abs(charges-check).max() < 1e-5)
    shutil.rmtree(tmpdir)


hirshi_dipoles_txt="""\
number of atoms: 2
  i        Z     Dipole-X     Dipole-Y     Dipole-Z      Dipole
------------------------------------------------------------------
  1   F    9      0.00000      0.00000     -0.06956      0.06956
  2   H    1      0.00003     -0.00001     -0.03371      0.03371
------------------------------------------------------------------
Molecular dipole due to ...
charges (q)       0.00000      0.00000     -0.37062      0.37062
dipoles (p)       0.00003     -0.00000     -0.10327      0.10327
q and p           0.00003     -0.00000     -0.47389      0.47389
total density     0.00000      0.00000     -0.47390      0.47390
------------------------------------------------------------------
Reproduction of the external molecular ESP ...
                     RMSD             RMS       CORRELATION
charges (q)       1.75095e-03     6.22261e-03       1.00
dipoles (p)       6.14792e-03     1.78334e-03       0.98
q and p           8.26040e-04     7.99629e-03       0.99
total density                     7.88796e-03"""

def test_load_dipoles():
    tmpdir = tempfile.mkdtemp("hipart-load-dipoles")
    fn_txt = os.path.join(tmpdir, "hirshi_dipoles.txt")
    f = open(fn_txt, "w")
    f.write(hirshi_dipoles_txt)
    f.close()
    dipoles = load_dipoles(fn_txt)
    assert(abs(dipoles[0,1] -  0.00002) < 1e-3)
    assert(abs(dipoles[1,2] - (-0.03385)) < 1e-3)
    shutil.rmtree(tmpdir)
